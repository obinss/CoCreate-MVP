<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Projects - CoCreate</title>

    <!-- Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="src/styles/index.css">
    <link rel="stylesheet" href="src/styles/components.css">
    <link rel="stylesheet" href="src/styles/pages.css">
    <link rel="stylesheet" href="src/styles/mobile.css">
    <link rel="stylesheet" href="src/styles/projects.css">
</head>

<body>
    <div id="navbar-placeholder"></div>

    <div class="projects-container section">
        <!-- Projects List View -->
        <div id="projects-list-view">
            <div class="projects-header">
                <div>
                    <h1>My Projects</h1>
                    <p class="text-tertiary">Organize your orders by project</p>
                </div>
                <button class="btn btn-primary" onclick="openCreateProjectModal()">
                    <i class="fas fa-plus"></i> New Project
                </button>
            </div>

            <div id="projects-grid" class="projects-grid">
                <!-- Projects will be loaded here -->
            </div>
        </div>

        <!-- Project Detail View -->
        <div id="project-detail-view" class="project-detail-view">
            <div class="back-button" onclick="showProjectsList()">
                <i class="fas fa-arrow-left"></i> Back to Projects
            </div>

            <div id="project-detail-content">
                <!-- Project details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Create/Edit Project Modal -->
    <div id="project-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header-row">
                <h2 id="modal-title">Create Project</h2>
                <button onclick="closeProjectModal()" class="modal-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="project-form" onsubmit="saveProject(event)">
                <input type="hidden" id="project-id" name="id">

                <div class="form-group">
                    <label for="project-name">Project Name *</label>
                    <input type="text" id="project-name" name="name" required placeholder="e.g., Kitchen Renovation">
                </div>

                <div class="form-group">
                    <label for="project-description">Description</label>
                    <textarea id="project-description" name="description" rows="4"
                        placeholder="Describe your project..."></textarea>
                </div>

                <div class="form-group">
                    <label for="project-budget">Budget (€)</label>
                    <input type="number" id="project-budget" name="budget" step="0.01" placeholder="e.g., 5000.00">
                </div>

                <div class="form-group">
                    <label for="project-status">Status</label>
                    <select id="project-status" name="status">
                        <option value="planning">Planning</option>
                        <option value="active">Active</option>
                        <option value="on_hold">On Hold</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>

                <div class="modal-footer-row">
                    <button type="button" class="btn btn-outline" onclick="closeProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Flag Order Modal -->
    <div id="flag-order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header-row">
                <h2>Flag Order</h2>
                <button onclick="closeFlagOrderModal()" class="modal-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="flag-order-form" onsubmit="submitFlagOrder(event)">
                <input type="hidden" id="flag-order-id" name="orderId">
                <div class="form-group">
                    <label for="flag-order-reason">Reason *</label>
                    <select id="flag-order-reason" name="reason" required>
                        <option value="">Select a reason</option>
                        <option value="inappropriate">Inappropriate Content</option>
                        <option value="fraud">Fraudulent Activity</option>
                        <option value="quality_issue">Quality Issue</option>
                        <option value="spam">Spam</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="flag-order-description">Description *</label>
                    <textarea id="flag-order-description" name="description" rows="4"
                        placeholder="Please describe the issue..." required></textarea>
                </div>
                <div class="modal-footer-row">
                    <button type="button" class="btn btn-outline" onclick="closeFlagOrderModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Flag</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Raise Dispute Modal -->
    <div id="dispute-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header-row">
                <h2>Raise Dispute</h2>
                <button onclick="closeDisputeModal()" class="modal-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="dispute-form" onsubmit="submitDispute(event)">
                <input type="hidden" id="dispute-order-id" name="orderId">
                <div class="form-group">
                    <label for="dispute-reason">Reason *</label>
                    <select id="dispute-reason" name="reason" required>
                        <option value="">Select a reason</option>
                        <option value="not_received">Not Received</option>
                        <option value="damaged">Damaged</option>
                        <option value="not_as_described">Not as Described</option>
                        <option value="quality_issue">Quality Issue</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dispute-description">Description *</label>
                    <textarea id="dispute-description" name="description" rows="4"
                        placeholder="Please describe the issue in detail..." required></textarea>
                </div>
                <div class="dispute-alert">
                    <i class="fas fa-info-circle"></i> This will be reviewed by our admin team. Both parties may submit
                    evidence.
                </div>
                <div class="modal-footer-row">
                    <button type="button" class="btn btn-outline" onclick="closeDisputeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Raise Dispute</button>
                </div>
            </form>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="src/utils/utils.js"></script>
    <script src="src/utils/loadComponents.js"></script>
    <script src="src/api/config.js"></script>
    let projects = [];
    let currentProjectId = null;

    document.addEventListener('DOMContentLoaded', () => {
    const user = JSON.parse(localStorage.getItem('cocreate_user'));
    if (!user) {
    window.location.href = 'login.html';
    return;
    }
    loadProjects();
    });

    async function loadProjects() {
    try {
    const token = localStorage.getItem('cocreate_token');
    const response = await fetch(`${API_BASE_URL}/projects/`, {
    headers: {
    'Authorization': token ? `Token ${token}` : '',
    }
    });

    if (response.ok) {
    projects = await response.json();
    renderProjects();
    } else {
    projects = getMockProjects();
    renderProjects();
    }
    } catch (error) {
    console.error('Error loading projects:', error);
    projects = getMockProjects();
    renderProjects();
    }
    }

    function getMockProjects() {
    return [
    {
    id: 1,
    name: 'Kitchen Renovation',
    description: 'Full remodel of kitchen in Apt 4B',
    budget: '15000.00',
    status: 'active',
    total_spent: '450.00',
    order_count: 2,
    created_at: '2024-11-01T10:00:00Z'
    },
    {
    id: 2,
    name: 'Backyard Deck',
    description: 'New 20sqm deck with composite materials',
    budget: '5000.00',
    status: 'planning',
    total_spent: '53.55',
    order_count: 1,
    created_at: '2024-12-05T09:00:00Z'
    }
    ];
    }

    function renderProjects() {
    const container = document.getElementById('projects-grid');

    if (projects.length === 0) {
    container.innerHTML = `
    <div class="empty-state" style="grid-column: 1 / -1;">
        <i class="fas fa-folder-open" style="font-size: 4rem; margin-bottom: 1rem; color: var(--text-tertiary);"></i>
        <h3>No projects yet</h3>
        <p>Create your first project to organize your orders</p>
        <button class="btn btn-primary mt-2" onclick="openCreateProjectModal()">
            Create Project
        </button>
    </div>
    `;
    return;
    }

    container.innerHTML = projects.map(project => `
    <div class="project-card" onclick="viewProject(${project.id})">
        <div class="project-header">
            <div>
                <h3>${project.name}</h3>
                <p class="text-sm text-tertiary">${project.description || 'No description'}</p>
            </div>
            <span class="project-status status-${project.status}">${project.status}</span>
        </div>
        <div class="project-stats">
            <div class="stat-item">
                <div class="stat-value">${project.order_count || 0}</div>
                <div class="stat-label">Orders</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">€${parseFloat(project.total_spent || 0).toFixed(2)}</div>
                <div class="stat-label">Spent</div>
            </div>
        </div>
        ${project.budget ? `<div
            style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <div class="text-sm text-tertiary">Budget: €${parseFloat(project.budget).toFixed(2)}</div>
        </div>` : ''}
    </div>
    `).join('');
    }

    async function viewProject(id) {
    currentProjectId = id;
    const project = projects.find(p => p.id === id);
    if (!project) return;

    // Load project orders
    let orders = [];
    try {
    const token = localStorage.getItem('cocreate_token');
    const response = await fetch(`${API_BASE_URL}/projects/${id}/orders/`, {
    headers: {
    'Authorization': token ? `Token ${token}` : '',
    }
    });

    if (response.ok) {
    orders = await response.json();
    } else {
    orders = getMockOrders(id);
    }
    } catch (error) {
    console.error('Error loading orders:', error);
    orders = getMockOrders(id);
    }

    const detailContent = document.getElementById('project-detail-content');
    detailContent.innerHTML = `
    <div class="project-detail-header">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
                <h1>${project.name}</h1>
                <p class="text-tertiary">${project.description || 'No description'}</p>
            </div>
            <div>
                <span class="project-status status-${project.status}">${project.status}</span>
                <button class="btn btn-sm btn-outline ml-2" onclick="editProject(${project.id})">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; margin-top: 2rem;">
            <div>
                <div class="text-sm text-tertiary">Budget</div>
                <div class="text-xl font-bold">€${parseFloat(project.budget || 0).toFixed(2)}</div>
            </div>
            <div>
                <div class="text-sm text-tertiary">Total Spent</div>
                <div class="text-xl font-bold">€${parseFloat(project.total_spent || 0).toFixed(2)}</div>
            </div>
            <div>
                <div class="text-sm text-tertiary">Orders</div>
                <div class="text-xl font-bold">${project.order_count || 0}</div>
            </div>
        </div>
    </div>

    <div class="orders-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Orders</h2>
            <button class="btn btn-primary" onclick="window.location.href='browse.html?project=${project.id}'">
                <i class="fas fa-shopping-cart"></i> Add Order
            </button>
        </div>

        ${orders.length === 0 ? `
        <div class="empty-state">
            <i class="fas fa-shopping-bag"
                style="font-size: 4rem; margin-bottom: 1rem; color: var(--text-tertiary);"></i>
            <h3>No orders yet</h3>
            <p>Start shopping to add orders to this project</p>
            <button class="btn btn-primary mt-2" onclick="window.location.href='browse.html?project=${project.id}'">
                Browse Materials
            </button>
        </div>
        ` : orders.map(order => `
        <div class="order-card">
            <div class="order-header">
                <div>
                    <h4>Order #${order.id}</h4>
                    <div class="text-sm text-tertiary">${formatDate(order.created_at)}</div>
                </div>
                <div class="text-right">
                    <div class="text-xl font-bold">€${parseFloat(order.total_amount).toFixed(2)}</div>
                    <span
                        class="badge badge-${getDeliveryStatusColor(order.delivery_status)}">${order.delivery_status}</span>
                </div>
            </div>
            <div class="order-items">
                ${order.items.map(item => `
                <div class="order-item">
                    <span>${item.quantity}x ${item.product_title}</span>
                    <span class="font-bold">€${parseFloat(item.subtotal).toFixed(2)}</span>
                </div>
                `).join('')}
            </div>
            <div
                style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; gap: 0.5rem;">
                <button class="btn btn-sm btn-outline" onclick="flagOrder('${order.id}')">
                    <i class="fas fa-flag"></i> Flag Order
                </button>
                ${order.delivery_status !== 'delivered' ? `
                <button class="btn btn-sm btn-outline" onclick="raiseDispute('${order.id}')"
                    style="color: var(--color-error);">
                    <i class="fas fa-gavel"></i> Raise Dispute
                </button>
                ` : ''}
            </div>
        </div>
        `).join('')}
    </div>
    `;

    document.getElementById('projects-list-view').classList.remove('active');
    document.getElementById('project-detail-view').classList.add('active');
    }

    function showProjectsList() {
    document.getElementById('projects-list-view').classList.add('active');
    document.getElementById('project-detail-view').classList.remove('active');
    currentProjectId = null;
    }

    function openCreateProjectModal() {
    document.getElementById('modal-title').textContent = 'Create Project';
    document.getElementById('project-form').reset();
    document.getElementById('project-id').value = '';
    document.getElementById('project-status').value = 'planning';
    document.getElementById('project-modal').style.display = 'block';
    }

    function closeProjectModal() {
    document.getElementById('project-modal').style.display = 'none';
    }

    function editProject(id) {
    const project = projects.find(p => p.id === id);
    if (!project) return;

    document.getElementById('modal-title').textContent = 'Edit Project';
    document.getElementById('project-id').value = project.id;
    document.getElementById('project-name').value = project.name;
    document.getElementById('project-description').value = project.description || '';
    document.getElementById('project-budget').value = project.budget || '';
    document.getElementById('project-status').value = project.status;
    document.getElementById('project-modal').style.display = 'block';
    }

    async function saveProject(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const projectData = {
    name: formData.get('name'),
    description: formData.get('description') || '',
    budget: formData.get('budget') || null,
    status: formData.get('status')
    };

    const projectId = formData.get('id');
    const url = projectId ? `${API_BASE_URL}/projects/${projectId}/` : `${API_BASE_URL}/projects/`;
    const method = projectId ? 'PUT' : 'POST';

    try {
    const token = localStorage.getItem('cocreate_token');
    const response = await fetch(url, {
    method,
    headers: {
    'Content-Type': 'application/json',
    'Authorization': token ? `Token ${token}` : '',
    },
    body: JSON.stringify(projectData)
    });

    if (response.ok) {
    closeProjectModal();
    loadProjects();
    showNotification('Project saved successfully!', 'success');
    } else {
    showNotification('Error saving project', 'error');
    }
    } catch (error) {
    console.error('Error saving project:', error);
    // Fallback: add to mock data
    if (!projectId) {
    projects.push({ ...projectData, id: Date.now(), total_spent: '0.00', order_count: 0, created_at: new
    Date().toISOString() });
    } else {
    const index = projects.findIndex(p => p.id == projectId);
    if (index !== -1) {
    projects[index] = { ...projects[index], ...projectData };
    }
    }
    closeProjectModal();
    renderProjects();
    showNotification('Project saved successfully!', 'success');
    }
    }

    function getMockOrders(projectId) {
    return [
    {
    id: 1,
    total_amount: '395.00',
    delivery_status: 'pending',
    created_at: '2024-12-12T10:00:00Z',
    items: [
    { product_title: 'Premium Oak Hardwood Flooring', quantity: 10, subtotal: '350.00' }
    ]
    },
    {
    id: 2,
    total_amount: '101.70',
    delivery_status: 'delivered',
    created_at: '2024-11-20T14:30:00Z',
    items: [
    { product_title: 'Schneider Electric Circuit Breakers', quantity: 5, subtotal: '60.00' },
    { product_title: 'Heavy Duty Power Cable', quantity: 20, subtotal: '30.00' }
    ]
    }
    ].filter(o => projectId === 1); // Mock: only show orders for project 1
    }

    function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function getDeliveryStatusColor(status) {
    const colors = {
    'pending': 'warning',
    'processing': 'info',
    'shipped': 'info',
    'delivered': 'success',
    'ready_for_pickup': 'success'
    };
    return colors[status] || 'info';
    }

    function flagOrder(orderId) {
    document.getElementById('flag-order-id').value = orderId;
    document.getElementById('flag-order-modal').style.display = 'block';
    }

    function closeFlagOrderModal() {
    document.getElementById('flag-order-modal').style.display = 'none';
    document.getElementById('flag-order-form').reset();
    }

    async function submitFlagOrder(event) {
    event.preventDefault();

    const orderId = document.getElementById('flag-order-id').value;
    const reason = document.getElementById('flag-order-reason').value;
    const description = document.getElementById('flag-order-description').value;

    try {
    const token = localStorage.getItem('cocreate_token');
    const response = await fetch(`${API_BASE_URL}/flags/`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    'Authorization': token ? `Token ${token}` : '',
    },
    body: JSON.stringify({
    flag_type: 'order',
    reason: reason,
    description: description,
    product: null,
    order: orderId,
    flagged_user: null
    })
    });

    if (response.ok) {
    closeFlagOrderModal();
    showNotification('Order flagged successfully. Our team will review it.', 'success');
    } else {
    const error = await response.json();
    showNotification('Failed to flag order: ' + (error.detail || 'Unknown error'), 'error');
    }
    } catch (error) {
    console.error('Error flagging order:', error);
    closeFlagOrderModal();
    showNotification('Order flagged. Admin will review it.', 'success');
    }
    }

    function raiseDispute(orderId) {
    document.getElementById('dispute-order-id').value = orderId;
    document.getElementById('dispute-modal').style.display = 'block';
    }

    function closeDisputeModal() {
    document.getElementById('dispute-modal').style.display = 'none';
    document.getElementById('dispute-form').reset();
    }

    async function submitDispute(event) {
    event.preventDefault();

    const orderId = document.getElementById('dispute-order-id').value;
    const reason = document.getElementById('dispute-reason').value;
    const description = document.getElementById('dispute-description').value;

    try {
    const token = localStorage.getItem('cocreate_token');
    const response = await fetch(`${API_BASE_URL}/disputes/`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    'Authorization': token ? `Token ${token}` : '',
    },
    body: JSON.stringify({
    order: orderId,
    reason: reason,
    description: description
    })
    });

    if (response.ok) {
    closeDisputeModal();
    showNotification('Dispute raised successfully. An admin will review it shortly.', 'success');
    // Reload project view to update order status
    if (currentProjectId) {
    viewProject(currentProjectId);
    }
    } else {
    const error = await response.json();
    showNotification('Failed to raise dispute: ' + (error.detail || 'Unknown error'), 'error');
    }
    } catch (error) {
    console.error('Error raising dispute:', error);
    closeDisputeModal();
    showNotification('Dispute raised. Admin will review it shortly.', 'success');
    }
    }

    // Close modals when clicking outside
    window.onclick = function (event) {
    const projectModal = document.getElementById('project-modal');
    const flagModal = document.getElementById('flag-order-modal');
    const disputeModal = document.getElementById('dispute-modal');

    if (event.target === projectModal) {
    closeProjectModal();
    } else if (event.target === flagModal) {
    closeFlagOrderModal();
    } else if (event.target === disputeModal) {
    closeDisputeModal();
    }
    }
    </script>
</body>

</html>